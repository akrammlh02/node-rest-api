<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DevAcademy - لوحة التحكم</title>
  <link rel="stylesheet" href="/dashboard-ar.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <link rel="icon" type="image/x-icon" href="/images/logo.png">
  <link rel="shortcut icon" href="/images/logo.png" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      font-family: 'Cairo', -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", Helvetica, Arial, sans-serif;
    }
  </style>
</head>

<body>
  <header>
    <nav>
      <img src="/images/logo2-removebg-preview.png" alt="Logo" height="55em">
      <ul class="nav-links">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <span style="transform: translateY(6px);" class="material-symbols-outlined">language</span> العربية
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="/dashboard/ar">العربية</a></li>
            <li><a class="dropdown-item" href="/dashboard">English</a></li>
          </ul>
        </li>
        <li class="account-information">
          <div class="image-div">
            <span class="material-symbols-outlined">
              contacts_product
            </span>
          </div>
          <div>
            <p style="padding: 0; margin: 0; font-weight: 700;">{{fullName}}</p>
            <p class="email" style="padding: 0; margin: 0;">{{email}}</p>
          </div>

        </li>
      </ul>

      <div class="menu">

        <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#staticBackdrop"
          aria-controls="staticBackdrop"><span class="material-symbols-outlined">menu</span></button>

        <div class="offcanvas offcanvas-start" data-bs-backdrop="static" tabindex="-1" id="staticBackdrop"
          aria-labelledby="staticBackdropLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasRightLabel">القائمة</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="إغلاق"></button>
          </div>
          <div class="offcanvas-body">

            <a onclick="showContent('dashboard', event)"><span class="material-symbols-outlined">dashboard</span>
              لوحة التحكم</a>
            <a onclick="showContent('myCourse', event)"><span class="material-symbols-outlined">book_ribbon</span>
              دوراتي</a>
            <a onclick="showContent('myCertificate', event)"><span class="material-symbols-outlined">school</span>
              شهاداتي</a>
            <a onclick="showContent('profile', event)"><span class="material-symbols-outlined">contacts_product</span>
              الملف الشخصي</a>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                aria-expanded="false"><span class="material-symbols-outlined">language</span>
                العربية
              </a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="/dashboard/ar">العربية</a></li>
                <li><a class="dropdown-item" href="/dashboard">English</a></li>
              </ul>
            </li>
            <hr>
            <a href="/ar"><span class="material-symbols-outlined">home</span> الرئيسية</a>
            <a href="/course/ar"><span class="material-symbols-outlined">book</span> الدورات</a>
            <a href="#" style="color: red; font-weight: 600;"><span class="material-symbols-outlined">logout</span>
              تسجيل الخروج</a>


            </ul>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <section class="first-section">
    <aside class="sidebar">
      <h2>القائمة</h2>
      <ul>
        <li><a href="#" onclick="showContent('dashboard', event)"><span
              class="material-symbols-outlined">dashboard</span>
            لوحة التحكم</a></li>
        <li><a href="#" onclick="showContent('myCourse', event)"><span
              class="material-symbols-outlined">book_ribbon</span> دوراتي</a></li>
        <li><a href="#" onclick="showContent('myCertificate', event)"><span
              class="material-symbols-outlined">school</span> شهاداتي</a></li>
        <li><a href="#" onclick="showContent('profile', event)"><span
              class="material-symbols-outlined">contacts_product</span> الملف الشخصي</a></li>
        <hr>
        <li><a href="/ar"><span class="material-symbols-outlined">home</span> الرئيسية</a></li>
        <li><a href="/course/ar"><span class="material-symbols-outlined">book</span> الدورات</a></li>
        <li><a href="/logout" style="color: red; font-weight: 600;"><span
              class="material-symbols-outlined">logout</span>
            تسجيل الخروج</a></li>
      </ul>
    </aside>
    <!-- ======== قسم لوحة التحكم ======== -->
    <section class="dashboard active" id="dashboard">
      <div class="welcome-div">
        <h2>مرحباً، {{fullName}}</h2>
        <p>تابع تعلمك</p>
      </div>
      <div class="statistic">
        <div class="card">
          <h1 id="enrolledCountAr">{{enrolledCount}}</h1>
          <p>الدورات المسجلة</p>
        </div>
        <div class="card">
          <h1 id="completedCountAr">0</h1>
          <p>الدورات المكتملة</p>
        </div>
        <div class="card">
          <h1 id="certificateCountAr">0</h1>
          <p>الشهادات</p>
        </div>
        <div class="card">
          <h1 id="learningHoursAr">0</h1>
          <p>ساعات التعلم</p>
        </div>
      </div>
      <div class="recent-course">
        <div class="top-content">
          <h3>دوراتك الأخيرة</h3>
          <a href="#" onclick="showContent('myCourse', event)">عرض الكل <span style="transform: translateY(6px);"
              class="material-symbols-outlined">
              arrow_forward
            </span></a>
        </div>
        <div class="courses" id="recentCoursesContainerAr">
          {{#if purchasedCourses}}
            {{#each purchasedCourses}}
            <div class="course-card">
              <img src="{{thumbnail_url}}" alt="{{title}}" onerror="this.src='/images/front-end-1.jpg'">
              <div class="course-info">
                <h4>{{title}}</h4>
                <p>{{description}}</p>
                <a href="/course/course-view?id={{course_id}}" class="btn-continue">متابعة التعلم</a>
              </div>
            </div>
            {{/each}}
          {{else}}
            <span class="material-symbols-outlined">
              import_contacts
            </span>
            <p>لم تسجل في أي دورة بعد</p>
            <a href="/course/ar">تصفح الدورات</a>
          {{/if}}
        </div>
      </div>

    </section>

    <!-- ========== قسم دوراتي =========== -->
    <section class="myCourse" id="myCourse" style="display: none;">
      <h1>دوراتي</h1>
      <p>تابع تقدمك في الدورات المسجلة</p>
      <div class="recent-course">
        <div class="top-content">
          <h3 style="font-size: 24px; font-weight: 500;">دوراتك</h3>
          <a href="/course/ar">تصفح المزيد من الدورات <span
              style="transform: translateY(6px);" class="material-symbols-outlined">
              arrow_forward
            </span></a>
        </div>
        <div class="courses" id="myCoursesContainerAr">
          {{#if purchasedCourses}}
            {{#each purchasedCourses}}
            <div class="course-card">
              <img src="{{thumbnail_url}}" alt="{{title}}" onerror="this.src='/images/front-end-1.jpg'">
              <div class="course-info">
                <h4>{{title}}</h4>
                <p>{{description}}</p>
                <div class="course-meta">
                  <span><span class="material-symbols-outlined">alarm</span> {{duration_hours}} ساعة</span>
                </div>
                <a href="/course/course-view?id={{course_id}}" class="btn-continue">متابعة التعلم</a>
              </div>
            </div>
            {{/each}}
          {{else}}
            <span class="material-symbols-outlined">
              import_contacts
            </span>
            <p>لم تسجل في أي دورة بعد</p>
            <a href="/course/ar">تصفح الدورات</a>
          {{/if}}
        </div>
      </div>
    </section>

    <!-- ======== قسم شهاداتي ========= -->
    <section class="myCertificate" id="myCertificate" style="display: none;">
      <h1>شهاداتي</h1>
      <div>
        <span class="material-symbols-outlined">school</span>
        <p>لا توجد شهادات بعد</p>
      </div>
    </section>

    <!-- =========  الملف الشخصي ========= -->
    <section class="profile" id="profile" style="display: none;">
      <h1>الملف الشخصي</h1>
      <div class="container">
        <div class="information-div">
          <h5>المعلومات الشخصية</h5>
          <div class="mb-3">
            <label for="exampleFormControlInput1" class="form-label">الاسم الكامل</label>
            <input type="text" class="form-control" id="exampleFormControlInput1" value="{{fullName}}"
              placeholder="أكرم مليحي">
          </div>
          <div class="mb-3">
            <label for="exampleFormControlInput1" class="form-label">البريد الإلكتروني</label>
            <input type="email" class="form-control" id="exampleFormControlInput1"
              placeholder="akrammelihi2003@gmail.com" value="{{email}}" disabled>
          </div>
          <div>
            <button type="button" class="btn btn-primary">حفظ التغييرات</button>
          </div>
        </div>
        <div class="password-div">
          <h5>تغيير كلمة المرور</h5>
          <div class="mb-3">
            <label for="exampleFormControlInput1" class="form-label">كلمة المرور الحالية</label>
            <input type="password" class="form-control" id="exampleFormControlInput1">
          </div>
          <div class="mb-3">
            <label for="exampleFormControlInput1" class="form-label">كلمة المرور الجديدة</label>
            <input type="password" class="form-control" id="exampleFormControlInput1">
          </div>
          <div class="mb-3">
            <label for="exampleFormControlInput1" class="form-label">تأكيد كلمة المرور</label>
            <input type="password" class="form-control" id="exampleFormControlInput1">
          </div>
          <div>
            <button type="button" class="btn btn-primary">حفظ التغييرات</button>
          </div>
        </div>
      </div>
    </section>



  </section>



  <script>
    // Check if user is still logged in
    async function checkSession() {
      try {
        const response = await fetch('/api/check-session', {
          method: 'GET',
          credentials: 'include'
        });
        
        if (!response.ok || response.status === 401) {
          // Session expired or invalid, redirect to login
          window.location.replace('/login/ar');
          return false;
        }
        return true;
      } catch (error) {
        console.error('Session check failed:', error);
        window.location.replace('/login/ar');
        return false;
      }
    }

    // Check session on page load
    window.addEventListener('load', async () => {
      const isValid = await checkSession();
      if (isValid) {
        showContent('dashboard');
        loadDashboardStatsAr();
      }
    });
    
    async function loadDashboardStatsAr() {
      try {
        const response = await fetch('/dashboard/api/stats');
        const result = await response.json();
        
        if (result.success) {
          const stats = result.stats;
          document.getElementById('enrolledCountAr').textContent = stats.enrolledCourses || 0;
          document.getElementById('completedCountAr').textContent = stats.completedCourses || 0;
          document.getElementById('certificateCountAr').textContent = stats.certificates || 0;
          document.getElementById('learningHoursAr').textContent = stats.learningHours || 0;
        }
      } catch (error) {
        console.error('Error loading dashboard stats:', error);
      }
    }

    // Check session when user navigates back (handles back button)
    window.addEventListener('pageshow', async (event) => {
      // If page is loaded from cache (back button), check session
      if (event.persisted) {
        await checkSession();
      }
    });

    // Prevent back button navigation to cached dashboard
    window.addEventListener('popstate', async (event) => {
      await checkSession();
    });

    function showContent(section, event) {
      // Hide all sections
      const sections = document.querySelectorAll('.dashboard, .myCourse, .myCertificate, .profile');
      sections.forEach(sec => sec.style.display = 'none');

      // Show the selected one
      document.getElementById(section).style.display = 'block';

      // Handle active class
      const links = document.querySelectorAll('.sidebar ul li a');
      links.forEach(link => link.classList.remove('active'));
      if (event) event.target.classList.add('active');
      
      // Load data when switching to myCourse
      if (section === 'myCourse') {
        loadMyCoursesAr();
      }
    }
    
    async function loadMyCoursesAr() {
      try {
        const response = await fetch('/dashboard/api/my-courses');
        const result = await response.json();
        
        if (result.success && result.courses.length > 0) {
          const container = document.getElementById('myCoursesContainerAr');
          container.innerHTML = result.courses.map(course => `
            <div class="course-card">
              <img src="${course.thumbnail_url || '/images/front-end-1.jpg'}" alt="${course.title}" onerror="this.src='/images/front-end-1.jpg'">
              <div class="course-info">
                <h4>${course.title}</h4>
                <p>${course.description || ''}</p>
                <div class="course-meta">
                  <span><span class="material-symbols-outlined">alarm</span> ${course.duration_hours || 0} ساعة</span>
                </div>
                <a href="/course/course-view?id=${course.course_id}" class="btn-continue">متابعة التعلم</a>
              </div>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Error loading my courses:', error);
      }
    }
  </script>






  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"></script>
</body>

</html>