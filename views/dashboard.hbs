<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DevAcademy - Dashboard</title>
  <link rel="stylesheet" href="dashboard.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <link rel="icon" type="image/x-icon" href="/images/logo.png">
  <link rel="shortcut icon" href="/images/logo.png" type="image/x-icon">
</head>

<body>
  <header>
    <nav>
      <img src="/images/logo2-removebg-preview.png" alt="Logo" height="55em">
      <ul class="nav-links">
        {{!-- <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <span style="transform: translateY(6px);" class="material-symbols-outlined">language</span> English
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="/dashboard/ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</a></li>
            <li><a class="dropdown-item" href="/dashboard">English</a></li>
          </ul>
        </li> --}}
        <li class="account-information">
          <div class="image-div">
            <span class="material-symbols-outlined">
              contacts_product
            </span>
          </div>
          <div>
            <p style="padding: 0; margin: 0; font-weight: 700;">{{fullName}}</p>
            <p class="email" style="padding: 0; margin: 0;">{{email}}</p>
          </div>

        </li>
      </ul>

      <div class="menu">

        <button class="btn btn-primary menu-button" type="button" data-bs-toggle="offcanvas"
          data-bs-target="#offcanvasRight" aria-controls="offcanvasRight"><span
            class="material-symbols-outlined">menu</span></button>

        <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasRightLabel">Menu</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">

            <a onclick="showContent('dashboard', event)" style="cursor: pointer !important;"><span
                class="material-symbols-outlined">dashboard</span>
              Dashboard</a>
            <a onclick="showContent('myCourse', event)" style="cursor: pointer !important;"><span
                class="material-symbols-outlined">book_ribbon</span> My
              Course</a>
            <a onclick="showContent('myCertificate', event)" style="cursor: pointer !important;"><span
                class="material-symbols-outlined">school</span> My
              Certificate</a>
            <a onclick="showContent('profile', event)" style="cursor: pointer !important;"><span
                class="material-symbols-outlined">contacts_product</span>
              Profile</a>
            {{!-- <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false"><span
                  class="material-symbols-outlined">language</span>
                English
              </a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="/dashboard/ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</a></li>
                <li><a class="dropdown-item" href="/dashboard">English</a></li>
              </ul>
            </li> --}}
            <hr>
            <a href="/"><span class="material-symbols-outlined">home</span> Home</a>
            <a href="/course"><span class="material-symbols-outlined">book</span> Courses</a>
            <a href="/quiz"><span class="material-symbols-outlined">quiz</span> Quiz</a>
            <a href="/logout" style="color: red; font-weight: 600;"><span
                class="material-symbols-outlined">logout</span>
              Logout</a>


            </ul>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <section class="first-section">
    <aside class="sidebar">
      <h2>Menu</h2>
      <ul>
        <li><a onclick="showContent('dashboard', event)"><span class="material-symbols-outlined">dashboard</span>
            Dashboard</a></li>
        <li><a onclick="showContent('myCourse', event)"><span class="material-symbols-outlined">book_ribbon</span> My
            Course</a></li>
        <li><a onclick="showContent('myCertificate', event)"><span class="material-symbols-outlined">school</span> My
            Certificate</a></li>
        <li><a onclick="showContent('profile', event)"><span class="material-symbols-outlined">contacts_product</span>
            Profile</a></li>
        <li><a href="/quiz"><span class="material-symbols-outlined">quiz</span> Programming Quiz</a></li>
        <hr>
        <li><a href="/"><span class="material-symbols-outlined">home</span> Home</a></li>
        <li><a href="/course"><span class="material-symbols-outlined">book</span> Courses</a></li>
        <li><a href="/logout" style="color: red !important; font-weight: 700 !important;"><span
              class="material-symbols-outlined">logout</span>
            Logout</a></li>
      </ul>
    </aside>
    <!-- ======== Dashboard section ======== -->
    <section class="dashboard active" id="dashboard">
      <div class="welcome-div">
        <div class="welcome-content">
          <h2>Welcome back, {{fullName}}! ðŸ‘‹</h2>
          <p>Continue your learning journey</p>
        </div>
        <div class="welcome-stats">
          <div class="quick-stat">
            <span class="material-symbols-outlined">trending_up</span>
            <div>
              <strong id="enrolledCount">{{enrolledCount}}</strong>
              <span>Enrolled</span>
            </div>
          </div>
        </div>
      </div>

      <div class="statistic">
        <div class="stat-card stat-card-primary">
          <div class="stat-icon">
            <span class="material-symbols-outlined">book_ribbon</span>
          </div>
          <div class="stat-content">
            <h1 id="enrolledCountStat">{{enrolledCount}}</h1>
            <p>Enrolled Courses</p>
          </div>
        </div>
        <div class="stat-card stat-card-success">
          <div class="stat-icon">
            <span class="material-symbols-outlined">check_circle</span>
          </div>
          <div class="stat-content">
            <h1 id="completedCount">0</h1>
            <p>Completed Courses</p>
          </div>
        </div>
        <div class="stat-card stat-card-warning">
          <div class="stat-icon">
            <span class="material-symbols-outlined">school</span>
          </div>
          <div class="stat-content">
            <h1 id="certificateCount">0</h1>
            <p>Certificates</p>
          </div>
        </div>
        <div class="stat-card stat-card-info">
          <div class="stat-icon">
            <span class="material-symbols-outlined">schedule</span>
          </div>
          <div class="stat-content">
            <h1 id="learningHours">0</h1>
            <p>Learning Hours</p>
          </div>
        </div>
      </div>

      <div class="courses-section">
        <div class="section-header">
          <h3>My Courses</h3>
          <a href="/course" class="view-all-link">Browse More <span
              class="material-symbols-outlined">arrow_forward</span></a>
        </div>
        <div class="courses-grid" id="recentCoursesContainer">
          {{#if purchasedCourses}}
          {{#each purchasedCourses}}
          <div class="course-card-modern" data-course-id="{{course_id}}">
            <div class="course-image-wrapper">
              <img src="{{thumbnail_url}}" alt="{{title}}" onerror="this.src='/images/front-end-1.jpg'">
              <div class="course-overlay">
                <a href="#" onclick="continueLearning({{course_id}}); return false;" class="btn-overlay">
                  <span class="material-symbols-outlined">play_circle</span>
                </a>
              </div>
            </div>
            <div class="course-card-content">
              <div class="course-header">
                <h4>{{title}}</h4>
                <span class="course-badge">Active</span>
              </div>
              <p class="course-description">{{description}}</p>
              <div class="course-progress-wrapper">
                <div class="progress-info">
                  <span>Progress</span>
                  <span class="progress-percentage" id="progress-{{course_id}}">0%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" id="progress-bar-{{course_id}}" style="width: 0%"></div>
                </div>
              </div>
              <div class="course-footer">
                <a href="#" onclick="continueLearning({{course_id}}); return false;" class="btn-continue-modern">
                  <span class="material-symbols-outlined">play_arrow</span>
                  Continue Learning
                </a>
              </div>
            </div>
          </div>
          {{/each}}
          {{else}}
          <div class="empty-state-modern">
            <span class="material-symbols-outlined">import_contacts</span>
            <h3>No courses yet</h3>
            <p>Start your learning journey by enrolling in a course</p>
            <a href="/course" class="btn-browse">Browse Courses</a>
          </div>
          {{/if}}
        </div>
      </div>
    </section>

    <!-- ========== My Course section =========== -->
    <section class="myCourse" id="myCourse" style="display: none;">
      <div class="page-header">
        <div>
          <h1>My Courses</h1>
          <p>Track your progress and continue learning</p>
        </div>
        {{!-- <a href="/course" class="btn-browse-courses">
          <span class="material-symbols-outlined">add</span>
          Browse More Courses
        </a> --}}
      </div>
      <div class="courses-grid" id="myCoursesContainer">
        {{#if purchasedCourses}}
        {{#each purchasedCourses}}
        <div class="course-card-modern" data-course-id="{{course_id}}">
          <div class="course-image-wrapper">
            <img src="{{thumbnail_url}}" alt="{{title}}" onerror="this.src='/images/front-end-1.jpg'">
            <div class="course-overlay">
              <a href="#" onclick="continueLearning({{course_id}}); return false;" class="btn-overlay">
                <span class="material-symbols-outlined">play_circle</span>
              </a>
            </div>
          </div>
          <div class="course-card-content">
            <div class="course-header">
              <h4>{{title}}</h4>
              <span class="course-badge">Active</span>
            </div>
            <p class="course-description">{{description}}</p>
            <div class="course-meta-info">
              <span><span class="material-symbols-outlined">alarm</span> {{duration_hours}} hours</span>
              <span><span class="material-symbols-outlined">book_ribbon</span> Lessons</span>
            </div>
            <div class="course-progress-wrapper">
              <div class="progress-info">
                <span>Progress</span>
                <span class="progress-percentage" id="progress-my-{{course_id}}">0%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" id="progress-bar-my-{{course_id}}" style="width: 0%"></div>
              </div>
            </div>
            <div class="course-footer">
              <a href="#" onclick="continueLearning({{course_id}}); return false;" class="btn-continue-modern">
                <span class="material-symbols-outlined">play_arrow</span>
                Continue Learning
              </a>
            </div>
          </div>
        </div>
        {{/each}}
        {{else}}
        <div class="empty-state-modern">
          <span class="material-symbols-outlined">import_contacts</span>
          <h3>No courses yet</h3>
          <p>Start your learning journey by enrolling in a course</p>
          <a href="/course" class="btn-browse">Browse Courses</a>
        </div>
        {{/if}}
      </div>
    </section>

    <!-- ======== My Certificate section ========= -->
    <section class="myCertificate" id="myCertificate" style="display: none;">
      <div class="page-header">
        <h1>My Certificates</h1>
        <p>View and download your course completion certificates</p>
      </div>
      <div id="certificatesContainer" class="certificates-grid">
        <!-- Certificates will be loaded here -->
      </div>
    </section>

    <!-- =========  Profile ========= -->
    <section class="profile" id="profile" style="display: none;">
      <h1>Profile</h1>
      <div class="container">
        <div class="information-div">
          <h5>Personal information</h5>
          <form id="profileForm">
            <div class="mb-3">
              <label for="fullNameInput" class="form-label">Full Name</label>
              <input type="text" class="form-control" id="fullNameInput" placeholder="Akram Melihi" value="{{fullName}}"
                required>
            </div>
            <div class="mb-3">
              <label for="emailInput" class="form-label">Email address</label>
              <input type="email" class="form-control" id="emailInput" placeholder="akrammelihi2003@gmail.com"
                value="{{email}}" disabled>
            </div>
            <div id="profileMessage" class="alert" style="display: none;"></div>
            <div>
              <button type="submit" class="btn btn-primary">Save changes</button>
            </div>
          </form>
        </div>
        <div class="password-div">
          <h5>Change Password</h5>
          <form id="passwordForm">
            <div class="mb-3">
              <label for="currentPassword" class="form-label">Current Password</label>
              <div class="password-input-wrapper">
                <input type="password" class="form-control" id="currentPassword" required>
                <span class="toggle-password material-symbols-outlined"
                  onclick="togglePassword('currentPassword')">visibility</span>
              </div>
            </div>
            <div class="mb-3">
              <label for="newPassword" class="form-label">New Password</label>
              <div class="password-input-wrapper">
                <input type="password" class="form-control" id="newPassword" required minlength="6">
                <span class="toggle-password material-symbols-outlined"
                  onclick="togglePassword('newPassword')">visibility</span>
              </div>
              <div class="password-strength" id="passwordStrength"></div>
            </div>
            <div class="mb-3">
              <label for="confirmPassword" class="form-label">Confirm Password</label>
              <div class="password-input-wrapper">
                <input type="password" class="form-control" id="confirmPassword" required>
                <span class="toggle-password material-symbols-outlined"
                  onclick="togglePassword('confirmPassword')">visibility</span>
              </div>
              <div id="passwordMatch" class="password-match"></div>
            </div>
            <div id="passwordMessage" class="alert" style="display: none;"></div>
            <div>
              <button type="submit" class="btn btn-primary">Save changes</button>
            </div>
          </form>
        </div>
      </div>
    </section>



  </section>



  <script src="/dashboard.js"></script>
  <script>
    // Check if user is still logged in
    async function checkSession() {
      try {
        const response = await fetch('/api/check-session', {
          method: 'GET',
          credentials: 'include'
        });

        if (!response.ok || response.status === 401) {
          // Session expired or invalid, redirect to login
          window.location.replace('/login');
          return false;
        }
        return true;
      } catch (error) {
        console.error('Session check failed:', error);
        window.location.replace('/login');
        return false;
      }
    }

    // Check session on page load
    window.addEventListener('load', async () => {
      const isValid = await checkSession();
      if (isValid) {
        showContent('dashboard');
        loadDashboardStats();
        loadCourseProgress();
      }
    });

    // Check session when user navigates back (handles back button)
    window.addEventListener('pageshow', async (event) => {
      // If page is loaded from cache (back button), check session
      if (event.persisted) {
        await checkSession();
      }
    });

    // Prevent back button navigation to cached dashboard
    window.addEventListener('popstate', async (event) => {
      await checkSession();
    });

    function showContent(section, event) {
      // Hide all sections
      const sections = document.querySelectorAll('.dashboard, .myCourse, .myCertificate, .profile');
      sections.forEach(sec => sec.style.display = 'none');

      // Show the selected one
      document.getElementById(section).style.display = 'block';

      // Load data when section is shown
      if (section === 'myCertificate') {
        loadCertificates();
      } else if (section === 'myCourse') {
        loadMyCourses();
      } else if (section === 'dashboard') {
        loadDashboardStats();
        loadCourseProgress();
      }

      // Handle active class
      //const links = document.querySelectorAll('.sidebar ul li a');
      //links.forEach(link => link.classList.remove('active'));
      //if (event) event.target.classList.add('active');

      // Load data when switching to myCourse
      if (section === 'myCourse') {
        loadMyCourses();
      }
    }

    // Profile update functionality
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fullName = document.getElementById('fullNameInput').value;
      const messageDiv = document.getElementById('profileMessage');

      try {
        const response = await fetch('/dashboard/api/update-profile', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ fullName })
        });

        const result = await response.json();

        if (result.success) {
          messageDiv.className = 'alert alert-success';
          messageDiv.textContent = result.message || 'Profile updated successfully!';
          messageDiv.style.display = 'block';
          setTimeout(() => {
            messageDiv.style.display = 'none';
            location.reload();
          }, 2000);
        } else {
          messageDiv.className = 'alert alert-danger';
          messageDiv.textContent = result.message || 'Failed to update profile';
          messageDiv.style.display = 'block';
        }
      } catch (error) {
        messageDiv.className = 'alert alert-danger';
        messageDiv.textContent = 'Error updating profile. Please try again.';
        messageDiv.style.display = 'block';
      }
    });

    // Password change functionality
    document.getElementById('passwordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const messageDiv = document.getElementById('passwordMessage');

      // Validation
      if (newPassword !== confirmPassword) {
        messageDiv.className = 'alert alert-danger';
        messageDiv.textContent = 'New passwords do not match!';
        messageDiv.style.display = 'block';
        return;
      }

      if (newPassword.length < 6) {
        messageDiv.className = 'alert alert-danger';
        messageDiv.textContent = 'Password must be at least 6 characters long!';
        messageDiv.style.display = 'block';
        return;
      }

      try {
        const response = await fetch('/dashboard/api/change-password', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ currentPassword, newPassword })
        });

        const result = await response.json();

        if (result.success) {
          messageDiv.className = 'alert alert-success';
          messageDiv.textContent = result.message || 'Password changed successfully!';
          messageDiv.style.display = 'block';
          document.getElementById('passwordForm').reset();
          setTimeout(() => {
            messageDiv.style.display = 'none';
          }, 3000);
        } else {
          messageDiv.className = 'alert alert-danger';
          messageDiv.textContent = result.message || 'Failed to change password';
          messageDiv.style.display = 'block';
        }
      } catch (error) {
        messageDiv.className = 'alert alert-danger';
        messageDiv.textContent = 'Error changing password. Please try again.';
        messageDiv.style.display = 'block';
      }
    });

    // Password strength indicator
    document.getElementById('newPassword').addEventListener('input', function () {
      const password = this.value;
      const strengthDiv = document.getElementById('passwordStrength');

      if (password.length === 0) {
        strengthDiv.innerHTML = '';
        return;
      }

      let strength = 0;
      let feedback = [];

      if (password.length >= 6) strength++;
      if (password.length >= 8) strength++;
      if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
      if (/[0-9]/.test(password)) strength++;
      if (/[^A-Za-z0-9]/.test(password)) strength++;

      let strengthText = '';
      let strengthClass = '';

      if (strength <= 2) {
        strengthText = 'Weak';
        strengthClass = 'weak';
      } else if (strength <= 3) {
        strengthText = 'Medium';
        strengthClass = 'medium';
      } else {
        strengthText = 'Strong';
        strengthClass = 'strong';
      }

      strengthDiv.innerHTML = `<div class="strength-indicator ${strengthClass}">Password Strength: <strong>${strengthText}</strong></div>`;
    });

    // Password match indicator
    document.getElementById('confirmPassword').addEventListener('input', function () {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = this.value;
      const matchDiv = document.getElementById('passwordMatch');

      if (confirmPassword.length === 0) {
        matchDiv.innerHTML = '';
        return;
      }

      if (newPassword === confirmPassword) {
        matchDiv.innerHTML = '<span class="text-success">âœ“ Passwords match</span>';
      } else {
        matchDiv.innerHTML = '<span class="text-danger">âœ— Passwords do not match</span>';
      }
    });

    // Toggle password visibility
    function togglePassword(inputId) {
      const input = document.getElementById(inputId);
      const toggle = input.nextElementSibling;

      if (input.type === 'password') {
        input.type = 'text';
        toggle.textContent = 'visibility_off';
      } else {
        input.type = 'password';
        toggle.textContent = 'visibility';
      }
    }

    // Continue learning - redirect to TV page with first lesson
    async function continueLearning(courseId) {
      try {
        const response = await fetch(`/dashboard/api/first-lesson/${courseId}`);
        const result = await response.json();

        if (result.success && result.lessonId) {
          window.location.href = `/course/tv?lessonId=${result.lessonId}`;
        } else {
          alert('No lessons found for this course');
        }
      } catch (error) {
        console.error('Error getting first lesson:', error);
        alert('Error loading course. Please try again.');
      }
    }
  </script>






  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"></script>
</body>

</html>