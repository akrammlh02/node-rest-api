<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DevAcademy - لوحة التحكم</title>
  <link rel="stylesheet" href="/admin.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <link rel="icon" type="image/x-icon" href="/images/logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      font-family: 'Cairo', -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", Helvetica, Arial, sans-serif;
    }
  </style>
</head>

<body>
  <header>
    <nav>
      <img src="/images/logo2-removebg-preview.png" alt="Logo" height="55em">
      <ul class="nav-links">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <span style="transform: translateY(6px);" class="material-symbols-outlined">language</span> العربية
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="/admin/ar">العربية</a></li>
            <li><a class="dropdown-item" href="/admin">English</a></li>
          </ul>
        </li>
        <li><button type="button" class="btn btn-danger"><a href="/logout/ar"> تسجيل الخروج</a></button></li>
      </ul>
      <div class="menu">
        <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight"
          aria-controls="offcanvasRight"><span class="material-symbols-outlined">menu</span></button>
        <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasRightLabel">القائمة</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <span style="transform: translateY(6px);" class="material-symbols-outlined">language</span> العربية
              </a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="/admin/ar">العربية</a></li>
                <li><a class="dropdown-item" href="/admin">English</a></li>
              </ul>
            </li>
            <div style="width: 50%;">
              <button type="button" class="btn btn-danger"><a href="/logout/ar"> تسجيل الخروج</a></button>
            </div>
          </div>
        </div>
      </div>
    </nav>
  </header>
  <main>
    <aside>
      <h2>القائمة</h2>
      <ul>
        <li><a onclick="afficheSection('Dashboard')">
            <span class="material-symbols-outlined">dashboard</span> لوحة التحكم</a>
        </li>
        <li><a onclick="afficheSection('Courses')">
            <span class="material-symbols-outlined">book</span>الدورات</a>
        </li>
        <li><a onclick="afficheSection('Clients')">
            <span class="material-symbols-outlined">group</span>العملاء</a>
        </li>
        <li><a onclick="afficheSection('Purchases')">
            <span class="material-symbols-outlined">local_mall</span>المشتريات</a>
        </li>
        <hr>
        <li><a style="color: red;" href="/logout/ar"><span class="material-symbols-outlined">logout</span>تسجيل الخروج</a>
        </li>
      </ul>
    </aside>
    <section class="right-side">
      <section id="Dashboard" class="dashboard-section">
        <div class="welcome">
          <h1>مرحباً، {{fullName}}</h1>
          <p>إليك ما يحدث على منصتك اليوم.</p>
        </div>
        <div class="cards">
          <div class="card">
            <div class="upside">
              <div class="card-icon" style="background: linear-gradient(135deg, #3b82f6, #06b6d4);">
                <span class="material-symbols-outlined">group</span>
              </div>
              <span class="trend-up material-symbols-outlined">trending_up</span>
            </div>
            <h3 id="totalUsersAr">0</h3>
            <p>إجمالي المستخدمين</p>
          </div>

          <div class="card">
            <div class="upside">
              <div class="card-icon" style="background: linear-gradient(135deg, #8b5cf6, #a855f7);">
                <span class="material-symbols-outlined">school</span>
              </div>
              <span class="trend-up material-symbols-outlined">trending_up</span>
            </div>
            <h3 id="totalCoursesAr">{{courses.length}}</h3>
            <p>إجمالي الدورات</p>
          </div>

          <div class="card">
            <div class="upside">
              <div class="card-icon" style="background: linear-gradient(135deg, #10b981, #34d399);">
                <span class="material-symbols-outlined">add_shopping_cart</span>
              </div>
              <span class="trend-up material-symbols-outlined">trending_up</span>
            </div>
            <h3 id="totalPurchasesAr">0</h3>
            <p>إجمالي المشتريات</p>
          </div>
          <div class="card">
            <div class="upside">
              <div class="card-icon" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">
                <span class="material-symbols-outlined">attach_money</span>
              </div>
              <span class="trend-up material-symbols-outlined">trending_up</span>
            </div>
            <h3 id="totalEarningsAr">0 دج</h3>
            <p>إجمالي الأرباح</p>
          </div>
        </div>
      </section>
      <section id="Courses" class="courses-section" style="display: none;">
        <div class="welcome">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h1>مرحباً بك في قسم الدورات</h1>
              <p>حيث يمكنك إدارة دوراتك وفصولك ودروسك.</p>
            </div>
            <button class="btn btn-primary" onclick="openAddCourseModal()"
              style="background-color: #7b09cd; border: none;">
              <span class="material-symbols-outlined" style="vertical-align: middle;">add</span> إضافة دورة
            </button>
          </div>
        </div>

        <div class="table-container">
          <h3>الدورات</h3>
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>العنوان</th>
                <th>الوصف</th>
                <th>السعر</th>
                <th>الفصول</th>
                <th>إجمالي الدروس</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="coursesTableBody">
              {{#each courses}}
              <tr>
                <td>
                  <strong>{{title}}</strong>
                </td>
                <td>{{description}}</td>
                <td>{{price}} دج</td>
                <td class="chapter-count-{{course_id}}">0</td>
                <td class="lesson-count-{{course_id}}">0</td>
                <td>
                  <button class="btn btn-sm btn-primary" onclick="manageCourse({{course_id}})" title="إدارة الفصول">
                    <span class="material-symbols-outlined">settings</span> إدارة
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteCourse({{course_id}})" title="حذف">
                    <span class="material-symbols-outlined">delete</span>
                  </button>
                </td>
              </tr>
              {{/each}}
            </tbody>
          </table>
        </div>
      </section>

      <!-- Add Course Modal -->
      <div class="modal fade" id="addCourseModal" tabindex="-1" aria-labelledby="addCourseModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addCourseModalLabel">إضافة دورة جديدة</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="addCourseForm">
                <div class="mb-3">
                  <label for="courseTitle" class="form-label">عنوان الدورة <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="courseTitle" required>
                </div>

                <div class="mb-3">
                  <label for="courseDescription" class="form-label">الوصف <span class="text-danger">*</span></label>
                  <textarea class="form-control" id="courseDescription" rows="3" required></textarea>
                </div>

                <div class="mb-3">
                  <label for="courseImage" class="form-label">صورة الدورة <span class="text-danger">*</span></label>
                  <input type="file" class="form-control" id="courseImage" accept="image/*" required>
                  <small class="form-text text-muted">قم برفع صورة للدورة (الحد الأقصى 5 ميجابايت)</small>
                  <div id="imagePreview" style="margin-top: 10px; display: none;">
                    <img id="previewImg" src="" alt="معاينة" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid #7b09cd;">
                  </div>
                  <input type="hidden" id="existingImageUrl" value="">
                </div>

                <div class="mb-3">
                  <label for="coursePrice" class="form-label">السعر <span class="text-danger">*</span></label>
                  <input type="number" class="form-control" id="coursePrice" step="0.01" min="0" required>
                </div>
                <div class="mb-3">
                  <label for="durationHours" class="form-label">مدة الدورة: (ساعات) <span
                      class="text-danger">*</span></label>
                  <input type="number" class="form-control" id="durationHours" required>
                </div>
                <div class="mb-3">
                  <label for="isPublished" class="form-label">الحالة <span class="text-danger">*</span></label>
                  <select type="select" class="form-control" id="isPublished" required>
                    <option value="draft">مسودة</option>
                    <option value="publish">منشور</option>
                  </select>
                </div>

                <div class="mb-3" id="messageCourse" style="display: none;">
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                  <button type="submit" class="btn btn-primary" style="background-color: #7b09cd; border: none;">حفظ
                    الدورة</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Manage Course Modal (Chapters) -->
      <div class="modal fade" id="manageCourseModal" tabindex="-1" aria-labelledby="manageCourseModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="manageCourseModalLabel">إدارة الدورة: <span id="manageCourseTitle"></span>
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="quick-add-section">
                <h6>إضافة فصل سريع</h6>
                <div class="input-group mb-3">
                  <input type="text" class="form-control" id="quickChapterTitle" placeholder="عنوان الفصل"
                    onkeypress="if(event.key === 'Enter') quickAddChapter()">
                  <button class="btn btn-primary" onclick="quickAddChapter()"
                    style="background-color: #7b09cd; border: none;">
                    <span class="material-symbols-outlined">add</span> إضافة
                  </button>
                </div>
              </div>
              <hr>
              <h6>الفصول</h6>
              <table class="table table-sm table-bordered">
                <thead>
                  <tr>
                    <th style="width: 50px;">الترتيب</th>
                    <th>العنوان</th>
                    <th>الدروس</th>
                    <th style="width: 200px;">الإجراءات</th>
                  </tr>
                </thead>
                <tbody id="chaptersTableBody">
                  <!-- Chapters will be dynamically added here -->
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Manage Chapter Modal (Lessons) -->
      <div class="modal fade" id="manageChapterModal" tabindex="-1" aria-labelledby="manageChapterModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="manageChapterModalLabel">إدارة الفصل: <span id="manageChapterTitle"></span>
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="quick-add-section">
                <h6>إضافة درس سريع</h6>
                <div class="mb-3">
                  <input type="text" class="form-control mb-2" id="quickLessonTitle" placeholder="عنوان الدرس"
                    onkeypress="if(event.key === 'Enter') document.getElementById('quickLessonVideoUrl').focus()">
                  <div class="input-group">
                    <input type="url" class="form-control" id="quickLessonVideoUrl" placeholder="رابط الفيديو"
                      onkeypress="if(event.key === 'Enter') quickAddLesson()">
                    <button class="btn btn-primary" onclick="quickAddLesson()"
                      style="background-color: #7b09cd; border: none;">
                      <span class="material-symbols-outlined">add</span> إضافة
                    </button>
                  </div>
                </div>
              </div>
              <hr>
              <h6>الدروس</h6>
              <table class="table table-sm table-bordered">
                <thead>
                  <tr>
                    <th style="width: 50px;">الترتيب</th>
                    <th>العنوان</th>
                    <th>رابط الفيديو</th>
                    <th style="width: 200px;">الإجراءات</th>
                  </tr>
                </thead>
                <tbody id="lessonsTableBody">
                  <!-- Lessons will be dynamically added here -->
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
            </div>
          </div>
        </div>
      </div>

      <section id="Clients" class="clients-section" style="display: none;">
        <div class="welcome">
          <h1>إدارة العملاء</h1>
          <p>إدارة جميع المستخدمين والعملاء المسجلين.</p>
        </div>

        <div class="table-container">
          <div class="section-header">
            <h3>جميع العملاء</h3>
            <div class="search-box">
              <input type="text" class="form-control" id="clientSearch" placeholder="البحث عن العملاء..."
                onkeyup="filterClients()">
              <span class="material-symbols-outlined search-icon">search</span>
            </div>
          </div>
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>الاسم</th>
                <th>البريد الإلكتروني</th>
                <th>تاريخ التسجيل</th>
                <th>الحالة</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="clientsTableBody">
              <!-- Clients will be dynamically added here -->
            </tbody>
          </table>
        </div>
      </section>

      <section id="Purchases" class="purchases-section" style="display: none;">
        <div class="welcome">
          <h1>إدارة المشتريات</h1>
          <p>عرض وإدارة جميع مشتريات الدورات والمعاملات.</p>
        </div>

        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-icon">
              <span class="material-symbols-outlined">shopping_cart</span>
            </div>
            <div class="stat-info">
              <h4 id="totalPurchasesAr">0</h4>
              <p>إجمالي المشتريات</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">
              <span class="material-symbols-outlined">attach_money</span>
            </div>
            <div class="stat-info">
              <h4 id="totalRevenueAr">0 دج</h4>
              <p>إجمالي الإيرادات</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">
              <span class="material-symbols-outlined">today</span>
            </div>
            <div class="stat-info">
              <h4 id="todayPurchasesAr">0</h4>
              <p>مشتريات اليوم</p>
            </div>
          </div>
        </div>

        <div class="table-container">
          <div class="section-header">
            <h3>جميع المشتريات</h3>
            <div class="filter-buttons">
              <button class="btn btn-filter active" onclick="filterPurchases('all')">الكل</button>
              <button class="btn btn-filter" onclick="filterPurchases('today')">اليوم</button>
              <button class="btn btn-filter" onclick="filterPurchases('week')">هذا الأسبوع</button>
              <button class="btn btn-filter" onclick="filterPurchases('month')">هذا الشهر</button>
            </div>
          </div>
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>رقم الشراء</th>
                <th>اسم العميل</th>
                <th>الدورة</th>
                <th>المبلغ</th>
                <th>التاريخ</th>
                <th>الحالة</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="purchasesTableBody">
              <!-- Purchases will be dynamically added here -->
            </tbody>
          </table>
        </div>
      </section>
    </section>
  </main>

  <script src="/admin-ar.js"></script>
  <script>
    function afficheSection(sectionId) {
      const sections = document.querySelectorAll('.dashboard-section, .courses-section, .clients-section, .purchases-section');
      sections.forEach(sec => sec.style.display = 'none');
      document.getElementById(sectionId).style.display = 'block';
      
      // Load data when section is shown
      if (sectionId === 'Clients') {
        loadClients();
      } else if (sectionId === 'Purchases') {
        loadPurchases();
      } else if (sectionId === 'Dashboard') {
        loadDashboardStats();
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Load course stats
      loadCourseStats();
      // Load dashboard stats
      loadDashboardStats();
      
      // Image preview functionality
      const courseImageInput = document.getElementById('courseImage');
      const imagePreview = document.getElementById('imagePreview');
      const previewImg = document.getElementById('previewImg');
      const existingImageUrl = document.getElementById('existingImageUrl');
      
      if (courseImageInput) {
        courseImageInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            if (file.size > 5 * 1024 * 1024) {
              alert('يجب أن يكون حجم الصورة أقل من 5 ميجابايت');
              e.target.value = '';
              return;
            }
            if (!file.type.startsWith('image/')) {
              alert('الرجاء اختيار ملف صورة');
              e.target.value = '';
              return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
              previewImg.src = e.target.result;
              imagePreview.style.display = 'block';
              existingImageUrl.value = '';
            };
            reader.readAsDataURL(file);
          } else {
            imagePreview.style.display = 'none';
          }
        });
      }
      
      // Setup course form
      const form = document.getElementById('addCourseForm');
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const editCourseId = document.getElementById('editCourseId')?.value || '';
          const courseTitle = document.getElementById('courseTitle').value;
          const courseDescription = document.getElementById('courseDescription').value;
          const courseImage = document.getElementById('courseImage');
          const coursePrice = document.getElementById('coursePrice').value;
          const courseCategory = document.getElementById('courseCategory')?.value || '';
          const message = document.getElementById('messageCourse');
          const isPublished = document.getElementById('isPublished').value;
          const durationHours = document.getElementById('durationHours').value;
          const existingUrl = existingImageUrl?.value || '';

          message.textContent = '';
          message.style.display = 'none';
          
          if (!courseTitle || !courseDescription || !coursePrice || !durationHours || !courseCategory) {
            message.textContent = 'الرجاء ملء جميع الحقول.';
            message.style.display = 'block';
            message.style.color = 'red';
            return;
          }
          
          if (!editCourseId && !courseImage.files[0]) {
            message.textContent = 'الرجاء رفع صورة للدورة.';
            message.style.display = 'block';
            message.style.color = 'red';
            return;
          }
          
          if (editCourseId && !courseImage.files[0] && !existingUrl) {
            message.textContent = 'الرجاء رفع صورة للدورة أو الاحتفاظ بالصورة الحالية.';
            message.style.display = 'block';
            message.style.color = 'red';
            return;
          }
          
          const url = editCourseId ? `/admin/updateCourse/${editCourseId}` : '/admin/addCourse';
          const method = editCourseId ? 'PUT' : 'POST';
          
          const formData = new FormData();
          formData.append('courseTitle', courseTitle);
          formData.append('courseDescription', courseDescription);
          formData.append('coursePrice', coursePrice);
          formData.append('courseCategory', courseCategory);
          formData.append('isPublished', isPublished);
          formData.append('durationHours', durationHours);
          
          if (courseImage.files[0]) {
            formData.append('courseImage', courseImage.files[0]);
          }
          
          if (editCourseId && existingUrl) {
            formData.append('existingImageUrl', existingUrl);
          }
          
          try {
            const response = await fetch(url, {
              method: method,
              body: formData
            });
            const result = await response.json();

            if (result.success) {
              message.textContent = result.message;
              message.style.display = 'block';
              message.style.color = 'green';
              setTimeout(() => location.reload(), 1000);
            } else {
              message.textContent = result.message || 'فشل في إضافة الدورة.';
              message.style.display = 'block';
              message.style.color = 'red';
            }
          } catch (error) {
            console.error('Error:', error);
            message.textContent = 'خطأ في الاتصال بالخادم.';
            message.style.display = 'block';
            message.style.color = 'red';
          }
        });
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"></script>
</body>

</html>

